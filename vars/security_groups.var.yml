---
common_stack: &common_stack
  state: "{{ state | default('present')}}"
  region: "{{ region }}"
  disable_rollback: true
  template_parameters: &common_stack_template_parameters
    Environment: "{{ Environment }}"
    Platform: CKAN
    VPC: "CKANVpc-{{ Environment }}"
  tags: &common_stack_tags
    Environment: "{{ Environment }}"
    Service: "CKAN"
    Division: "{{ Division }}"
    Owner: "{{ Owner }}"
    Version: "1.0"

cloudformation_stacks:
  - name: "CKAN-{{ Environment }}-CLOUDFRONT-HTTP-SECURITY-GROUP"
    template: "templates/cloudfront_security_group_http.cfn.yml"
    template_parameters:
      <<: *common_stack_template_parameters
    tags:
      <<: *common_stack_tags

  - <<: *common_stack
    name: "CKAN-{{ Environment }}-CLOUDFRONT-HTTPS-SECURITY-GROUP"
    template: "templates/cloudfront_security_group_https.cfn.yml"
    template_parameters:
      <<: *common_stack_template_parameters
    tags:
      <<: *common_stack_tags

  - name: "CKAN-{{ Environment }}-SECURITY-GROUPS"
    template: "templates/security_groups.cfn.yml"
    template_parameters:
      <<: *common_stack_template_parameters
      BambooAgentIp: "{{ lookup('aws_ssm', '/config/CKAN/cicdIpA', region=region) }}"
      BambooAgentIp2: "{{ lookup('aws_ssm', '/config/CKAN/cicdIpB', region=region) }}"
      BambooAgentSecurityGroup: "{{ lookup('aws_ssm', '/config/CKAN/cicdSecurityGroup', region=region) }}"
      VPCPeeringCidr: "{{ lookup('aws_ssm', '/config/CKAN/opsVpcCidr', region=region) }}"
    tags:
      <<: *common_stack_tags
