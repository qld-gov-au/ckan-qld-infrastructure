---
NonProductionGTMId: "GTM-NBSWN3"

common_stack:
  state: "{{ state | default('present')}}"
  region: "{{ region }}"
  disable_rollback: true
  template: "templates/Datashades-OpsWorks-CKAN-Stack.cfn.yml"
  template_parameters:
    ApplicationName: "{{ titlecase_name }}"
    ApplicationId: "{{ lowercase_name }}"
    ApplicationTitle: "{{ title }}"
    CKANSource: "{{ CKANSource }}"
    PublicTLD: "{{ public_tld }}"
    CacheAddress: "{{ Environment }}CKANCacheClusterAddress"
    StackVPC: "CKANVpc-{{ Environment }}"
    StackTLD: "{{ Environment }}CKANPrivateTLD"
    StackZone: "{{ Environment }}CKANPrivateHostedZone"
    CKANAdminEmail: "{{ lookup('aws_ssm', '/config/CKAN/' + Environment + '/app/' + lowercase_name + '/admin_email', region=region) }}"
    CKANAdminPW: "{{ lookup('aws_ssm', '/config/CKAN/' + Environment + '/app/' + lowercase_name + '/admin_password', region=region) }}"
    PGDBUser: "{{ lookup('aws_ssm', '/config/CKAN/' + Environment + '/db/' + lowercase_name + '_user', region=region) }}"
    PGDBPassword: "{{ lookup('aws_ssm', '/config/CKAN/' + Environment + '/db/' + lowercase_name + '_password', region=region) }}"
    BeakerSecret: "{{ lookup('aws_ssm', '/config/CKAN/' + Environment + '/app/' + lowercase_name + '/beaker_secret', region=region) }}"
    WebSubnets: "{{ Environment }}CKANWebSubnet"
    AppSubnets: "{{ Environment }}CKANAppSubnet"
    AdminSG: "{{ Environment }}CKANManagementSG"
    AppLBSG: "{{ Environment }}CKANAppLoadBalancerSG"
    CloudFrontSG: "{{ Environment }}CKANCloudfrontHTTPSSG"
    AppSG: "{{ Environment }}CKANAppAsgSG"
    DatabaseSG: "{{ Environment }}CKANDatabaseSG"
    CreateServiceRole: "yes"
    EnableDataStore: "{{ enable_datastore | default('no') }}"
    SSMKey: "{{ SSMKey | default('') }}"
    DefaultEC2Key: osssio-global-ckan
  tags:
    Environment: "{{ Environment }}"
    Service: "{{ titlecase_name }}"
    Division: "{{ Division }}"
    Owner: "{{ Owner }}"
    Version: "1.0"

cloudformation_stacks:
  - name: "{{ titlecase_name }}-PROD-OpsWorks-stack"
    template_parameters:
      Environment: PROD
      IntermediateTLD: ckan.services.qld.gov.au
      CookbookRevision: "2.0.1-qgov"
      ACMCertificateARN: "arn:aws:acm:ap-southeast-2:265326298602:certificate/29d2a412-555a-49d9-a20d-cfe598fd2ce1"
      GTMContainerId: "GTM-PJBVFG"
    tags:
      PowerManaged: "No"

  - name: "{{ titlecase_name }}-STAGING-OpsWorks-stack"
    template_parameters:
      Environment: STAGING
      IntermediateTLD: ckan.staging-services.qld.gov.au
      CookbookRevision: "2.0.1-qgov"
      ACMCertificateARN: "arn:aws:acm:ap-southeast-2:265326298602:certificate/c11bea3d-07d0-49df-9e44-1e81f048f576"
      GTMContainerId: "{{ NonProductionGTMId }}"
    tags:
      PowerManaged: "No"

  - name: "{{ titlecase_name }}-TRAINING-OpsWorks-stack"
    template_parameters:
      Environment: TRAINING
      IntermediateTLD: training.ckan.devpit140cs.qgov.net.au
      CookbookRevision: training
      ACMCertificateARN: "arn:aws:acm:ap-southeast-2:265326298602:certificate/f280a938-d6bb-4056-9a54-a94543bff03a"
      GTMContainerId: "{{ NonProductionGTMId }}"
    tags:
      PowerManaged: "Yes"

  - name: "{{ titlecase_name }}-DEV-OpsWorks-stack"
    template_parameters:
      Environment: DEV
      IntermediateTLD: dev.ckan.devpit140cs.qgov.net.au
      CookbookRevision: develop
      ACMCertificateARN: "arn:aws:acm:ap-southeast-2:265326298602:certificate/db8fbe61-7690-4953-9eaa-c3b30814d9e8"
      GTMContainerId: "{{ NonProductionGTMId }}"
    tags:
      PowerManaged: "Yes"
