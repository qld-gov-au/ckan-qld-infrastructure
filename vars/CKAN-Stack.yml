---
template: "templates/Datashades-OpsWorks-CKAN-Stack.cfn.yml"
enable_datastore: "{{ enable_datastore | default('no') }}"

cloudformation_stacks:
  - name: "{{ titlecase_name }}-PROD-OpsWorks-stack"
    state: "{{ state | default('present')}}"
    region: "{{ region }}"
    disable_rollback: true
    template: "{{ template }}"
    template_parameters:
      Environment: PROD
      ApplicationName: "{{ titlecase_name }}"
      ApplicationId: "{{ lowercase_name }}"
      StackTLD: ckan.services.qld.gov.au
      CacheAddress: PRDCKANCacheClusterAddress
      StackVPC: CKANVpc-PROD
      CKANSource: https://github.com/ckan/ckan/archive/ckan-2.7.3.zip
      DefaultEC2Key: osssio-global-ckan
      CKANAdminEmail: "{{ lookup('aws_ssm', '/config/CKAN/PROD/app/' + lowercase_name + '/admin_email', region=region) }}"
      CKANAdminPW: "{{ lookup('aws_ssm', '/config/CKAN/PROD/app/' + lowercase_name + '/admin_password', region=region) }}"
      PGDBUser: "{{ lookup('aws_ssm', '/config/CKAN/PROD/db/' + lowercase_name + '_user', region=region) }}"
      PGDBPassword: "{{ lookup('aws_ssm', '/config/CKAN/PROD/db/' + lowercase_name + '_password', region=region) }}"
      WebSubnets: PRODCKANWebSubnet
      AppSubnets: PRODCKANAppSubnet
      DbSubnets: PRODCKANDbSubnet
      AdminSG: PRODCKANManagementSG
      AppLBSG: PRODCKANAppLoadBalancerSG
      AppSG: PRODCKANAppAsgSG
      DatabaseSG: PRODCKANDatabaseSG
      CreateServiceRole: "yes"
      EnableDataStore: "{{ enable_datastore }}"
    tags:
      Environment: PROD
      Service: "{{ titlecase_name }}"
      itoc_monitored: false
      Division: Qld Online
      Owner: Development and Delivery
      Version: "1.0"
      PowerManaged: "No"

  - name: "{{ titlecase_name }}-STAGING-OpsWorks-stack"
    state: "{{ state | default('present')}}"
    region: "{{ region }}"
    disable_rollback: true
    template: "{{ template }}"
    template_parameters:
      Environment: STAGING
      ApplicationName: "{{ titlecase_name }}"
      ApplicationId: "{{ lowercase_name }}"
      StackTLD: ckan.staging-services.qld.gov.au
      CacheAddress: STAGINGCKANCacheClusterAddress
      StackVPC: CKANVpc-STAGING
      CKANSource: https://github.com/ckan/ckan/archive/ckan-2.7.3.zip
      DefaultEC2Key: osssio-global-ckan
      CKANAdminEmail: "{{ lookup('aws_ssm', '/config/CKAN/STAGING/app/' + lowercase_name + '/admin_email', region=region) }}"
      CKANAdminPW: "{{ lookup('aws_ssm', '/config/CKAN/STAGING/app/' + lowercase_name + '/admin_password', region=region) }}"
      PGDBUser: "{{ lookup('aws_ssm', '/config/CKAN/STAGING/db/' + lowercase_name + '_user', region=region) }}"
      PGDBPassword: "{{ lookup('aws_ssm', '/config/CKAN/STAGING/db/' + lowercase_name + '_password', region=region) }}"
      WebSubnets: STAGINGCKANWebSubnet
      AppSubnets: STAGINGCKANAppSubnet
      DbSubnets: STAGINGCKANDbSubnet
      AdminSG: STAGINGCKANManagementSG
      AppLBSG: STAGINGCKANAppLoadBalancerSG
      AppSG: STAGINGCKANAppAsgSG
      DatabaseSG: STAGINGCKANDatabaseSG
      CreateServiceRole: "yes"
      EnableDataStore: "{{ enable_datastore }}"
    tags:
      Environment: STAGING
      Service: "{{ titlecase_name }}"
      itoc_monitored: false
      Division: Qld Online
      Owner: Development and Delivery
      Version: "1.0"
      PowerManaged: "No"

  - name: "{{ titlecase_name }}-TRAINING-OpsWorks-stack"
    state: "{{ state | default('present')}}"
    region: "{{ region }}"
    disable_rollback: true
    template: "{{ template }}"
    template_parameters:
      Environment: TRAINING
      ApplicationName: "{{ titlecase_name }}"
      ApplicationId: "{{ lowercase_name }}"
      StackTLD: training.ckan.devpit140cs.qgov.net.au
      CacheAddress: TRAININGCKANCacheClusterAddress
      StackVPC: CKANVpc-TRAINING
      CKANSource: https://github.com/ckan/ckan/archive/ckan-2.7.3.zip
      DefaultEC2Key: osssio-global-ckan
      CKANAdminEmail: "{{ lookup('aws_ssm', '/config/CKAN/TRAINING/app/' + lowercase_name + '/admin_email', region=region) }}"
      CKANAdminPW: "{{ lookup('aws_ssm', '/config/CKAN/TRAINING/app/' + lowercase_name + '/admin_password', region=region) }}"
      PGDBUser: "{{ lookup('aws_ssm', '/config/CKAN/TRAINING/db/' + lowercase_name + '_user', region=region) }}"
      PGDBPassword: "{{ lookup('aws_ssm', '/config/CKAN/TRAINING/db/' + lowercase_name + '_password', region=region) }}"
      WebSubnets: TRAININGCKANWebSubnet
      AppSubnets: TRAININGCKANAppSubnet
      DbSubnets: TRAININGCKANDbSubnet
      AdminSG: TRAININGCKANManagementSG
      AppLBSG: TRAININGCKANAppLoadBalancerSG
      AppSG: TRAININGCKANAppAsgSG
      DatabaseSG: TRAININGCKANDatabaseSG
      CreateServiceRole: "yes"
      EnableDataStore: "{{ enable_datastore }}"
    tags:
      Environment: TRAINING
      Service: "{{ titlecase_name }}"
      itoc_monitored: false
      Division: Qld Online
      Owner: Development and Delivery
      Version: "1.0"
      PowerManaged: "Yes"

  - name: "{{ titlecase_name }}-DEV-OpsWorks-stack"
    state: "{{ state | default('present')}}"
    region: "{{ region }}"
    disable_rollback: true
    template: "templates/Datashades-OpsWorks-CKAN-Stack.cfn.yml"
    template_parameters:
      Environment: DEV
      ApplicationName: "{{ titlecase_name }}"
      ApplicationId: "{{ lowercase_name }}"
      StackTLD: dev.ckan.devpit140cs.qgov.net.au
      CacheAddress: DEVCKANCacheClusterAddress
      StackVPC: CKANVpc-DEV
      CKANSource: https://github.com/ckan/ckan/archive/ckan-2.7.5.zip
      DefaultEC2Key: osssio-global-ckan
      CKANAdminEmail: "{{ lookup('aws_ssm', '/config/CKAN/DEV/app/' + lowercase_name + '/admin_email', region=region) }}"
      CKANAdminPW: "{{ lookup('aws_ssm', '/config/CKAN/DEV/app/' + lowercase_name + '/admin_password', region=region) }}"
      PGDBUser: "{{ lookup('aws_ssm', '/config/CKAN/DEV/db/' + lowercase_name + '_user', region=region) }}"
      PGDBPassword: "{{ lookup('aws_ssm', '/config/CKAN/DEV/db/' + lowercase_name + '_password', region=region) }}"
      WebSubnets: DEVCKANWebSubnet
      AppSubnets: DEVCKANAppSubnet
      DbSubnets: DEVCKANDbSubnet
      AdminSG: DEVCKANManagementSG
      AppLBSG: DEVCKANAppLoadBalancerSG
      AppSG: DEVCKANAppAsgSG
      DatabaseSG: DEVCKANDatabaseSG
      CreateServiceRole: "yes"
      EnableDataStore: "{{ enable_datastore }}"
    tags:
      Environment: DEV
      Service: "{{ titlecase_name }}"
      itoc_monitored: false
      Division: Qld Online
      Owner: Development and Delivery
      Version: "1.0"
      PowerManaged: "Yes"
